<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>DireitoF√°cil ‚Äì CNIS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Inter', sans-serif; background: #f3f6f9; padding-top: 65px; }
    .navbar { background-color: #1a2d48; }
    .navbar-brand, .nav-link { color: white !important; }
    .card { padding: 30px; border-radius: 10px; box-shadow: 0 0 10px #ccc; background: white; }
    .cliente-info { background: #e9f1fa; padding: 20px; border-radius: 8px; margin-bottom: 25px; }
    .badge-ok { background-color: #198754; }
    .badge-aviso { background-color: #ffc107; color: #000; }
    .badge-erro { background-color: #dc3545; }
    .flex-container { display: flex; gap: 30px; flex-wrap: wrap; }
    .painel-lateral {
      min-width: 280px;
      max-width: 300px;
      background: #ffffff;
      border: 1px solid #ddd;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 6px rgba(0,0,0,0.05);
    }
  </style>
</head>
<body>

<nav class="navbar fixed-top navbar-expand-lg shadow">
  <div class="container-fluid">
    <a class="navbar-brand" href="painel.html">‚öñÔ∏è DireitoF√°cil</a>
    <button class="navbar-toggler bg-light" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMenu">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarMenu">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" href="index.html">In√≠cio</a></li>
        <li class="nav-item"><a class="nav-link" href="cadastro.html">Cadastro</a></li>
        <li class="nav-item"><a class="nav-link" href="escritorio.html">Escrit√≥rio</a></li>
        <li class="nav-item"><a class="nav-link" href="cnis.html">CNIS</a></li>
        <li class="nav-item"><a class="nav-link" href="#">Jur√≠dico</a></li>
        <li class="nav-item"><a class="nav-link" href="#">Relat√≥rios</a></li>
        <li class="nav-item"><a class="nav-link" href="#">Ferramentas</a></li>
      </ul>
    </div>
  </div>
</nav>

<div class="container mt-4">
  <div class="card">
    <h3 class="mb-4">üìÇ An√°lise do CNIS</h3>

    <div class="cliente-info">
      <strong>üë§ Nome:</strong> Paulo Cesar Ribeiro<br>
      <strong>üìÖ Data de nascimento:</strong> 20/12/1969<br>
      <strong>üî¢ Idade:</strong> 53 anos, 9 meses e 4 dias<br>
      <strong>‚öß Sexo:</strong> Masculino
    </div>

    <div class="mb-3">
      <label class="form-label"><img src="https://cdn-icons-png.flaticon.com/512/3580/3580283.png" width="24"> Upload do extrato CNIS (.txt)</label>
      <input type="file" class="form-control" id="uploadCnis" accept=".txt" />
    </div>

    <button class="btn btn-primary" onclick="lerCnis()">üîç Analisar Extrato</button>
    <div class="alert alert-success mt-3 d-none" id="msgAnalise">‚úÖ An√°lise conclu√≠da com sucesso!</div>

    <div class="mt-4 d-none flex-container" id="resultadoAnalise">
      <div id="relatorioCnis">

        <div style="flex: 1 1 60%;">
          <h5>üìä Resultado da An√°lise</h5>
          <table class="table table-bordered">
            <thead class="table-light">
              <tr>
                <th>Empresa</th>
                <th>Per√≠odo</th>
                <th>Remunera√ß√£o</th>
                <th>Status</th>
                <th>A√ß√£o</th>
              </tr>
            </thead>
            <tbody id="tabelaResultado"></tbody>
          </table>
          <div class="mt-3" id="resumoTempo"></div>
        </div>

        <div class="painel-lateral">
          <h6 class="mb-3">üßÆ Tempo por Empregador</h6>
          <ul class="list-group small" id="tempoEmpregador"></ul>
        </div>

      </div>

      <button class="btn btn-success mt-3" onclick="gerarRelatorioPDF()">üìÑ Gerar Relat√≥rio em PDF</button>
    </div>

    <div class="mt-4">
      <a href="painel.html" class="btn btn-outline-secondary">üîô Voltar ao Menu Principal</a>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
function gerarRelatorioPDF() {
  const relatorio = document.getElementById("relatorioCnis");
  const opt = {
    margin: 0.5,
    filename: 'relatorio_cnis.pdf',
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: 2 },
    jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
  };
  html2pdf().set(opt).from(relatorio).save();
}

function lerCnis() {
  const arquivo = document.getElementById("uploadCnis").files[0];
  if (!arquivo) return alert("Selecione um arquivo TXT!");

  const leitor = new FileReader();
  leitor.onload = function (e) {
    const linhas = e.target.result.split('\n');
    const tabela = document.getElementById("tabelaResultado");
    const tempoEmp = {};
    let totalValidos = 0;
    let totalLacunas = 0;
    let empresa = '', periodo = '', salario = '';

    tabela.innerHTML = '';
    document.getElementById("tempoEmpregador").innerHTML = '';

    linhas.forEach(linha => {
      if (linha.startsWith("EMPRESA:")) empresa = linha.split("EMPRESA:")[1].trim();
      if (linha.startsWith("PERIODO:")) periodo = linha.split("PERIODO:")[1].trim();
      if (linha.startsWith("REMUNERACAO:")) {
        salario = parseFloat(linha.split("REMUNERACAO:")[1].trim());
        const [inicio, fim] = periodo.split(' a ');
        const meses = calcularMeses(inicio, fim);

        let status = '', acao = '';
        if (salario === 0) {
          totalLacunas += meses;
          status = '<span class="badge badge-erro">Sem remunera√ß√£o</span>';
          acao = 'Recolher em aberto';
        } else if (salario > 7500) {
          totalValidos += meses;
          status = '<span class="badge badge-aviso">Acima do teto</span>';
          acao = 'Solicitar reembolso';
          tempoEmp[empresa] = (tempoEmp[empresa] || 0) + meses;
        } else {
          totalValidos += meses;
          status = '<span class="badge badge-ok">OK</span>';
          acao = '‚Äî';
          tempoEmp[empresa] = (tempoEmp[empresa] || 0) + meses;
        }

        const linhaHTML = `
          <tr>
            <td>${empresa}</td>
            <td>${periodo}</td>
            <td>R$ ${salario.toFixed(2)}</td>
            <td>${status}</td>
            <td>${acao}</td>
          </tr>`;
        tabela.innerHTML += linhaHTML;
      }
    });

    document.getElementById("msgAnalise").classList.remove("d-none");
    document.getElementById("resultadoAnalise").classList.remove("d-none");

    const resumo = `
      <strong>üü¢ Tempo com contribui√ß√£o:</strong> ${converterMeses(totalValidos)}<br>
      <strong>üî¥ Lacunas (sem contribui√ß√£o):</strong> ${converterMeses(totalLacunas)}
    `;
    document.getElementById("resumoTempo").innerHTML = resumo;

    const lista = document.getElementById("tempoEmpregador");
    Object.entries(tempoEmp).forEach(([nome, meses]) => {
      const item = document.createElement("li");
      item.className = "list-group-item d-flex justify-content-between align-items-center";
      item.innerHTML = `<span>${nome}</span> <span class="badge bg-primary">${converterMeses(meses)}</span>`;
      lista.appendChild(item);
    });
  };
  leitor.readAsText(arquivo);
}

function calcularMeses(inicio, fim) {
  const [m1, a1] = inicio.split("/").map(Number);
  const [m2, a2] = fim.split("/").map(Number);
  return (a2 - a1) * 12 + (m2 - m1) + 1;
}

function converterMeses(meses) {
  const anos = Math.floor(meses / 12);
  const resto = meses % 12;
  return `${anos}a ${resto}m`;
}
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
