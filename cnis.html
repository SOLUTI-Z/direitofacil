<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Análise do CNIS - DireitoFácil</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      background-color: #f8fafc;
      padding-top: 70px;
    }
    .navbar {
      background-color: #1a2d48;
    }
    .navbar-brand,
    .nav-link {
      color: #fff !important;
    }
    .cliente-info {
      background: #eef3f8;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .badge-ok { background-color: #198754; }
    .badge-aviso { background-color: #ffc107; color: #000; }
    .badge-erro { background-color: #dc3545; }
    .painel-lateral {
      background: #fff;
      border: 1px solid #ddd;
      padding: 15px;
      border-radius: 8px;
    }
  </style>
</head>
<body>

<!-- MENU -->
<nav class="navbar fixed-top navbar-expand-lg shadow">
  <div class="container-fluid">
    <a class="navbar-brand" href="painel.html">⚖️ DireitoFácil</a>
    <button class="navbar-toggler bg-light" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto">

        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">Cadastro</a>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="cadastro.html">🧍 Cliente</a></li>
            <li><a class="dropdown-item" href="escritorio.html">🏢 Escritório</a></li>
          </ul>
        </li>

        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">CNIS</a>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="cnis.html">📂 Analisar CNIS</a></li>
          </ul>
        </li>

        <li class="nav-item"><a class="nav-link" href="juridico.html">Jurídico</a></li>
        <li class="nav-item"><a class="nav-link" href="relatorios.html">Relatórios</a></li>
        <li class="nav-item"><a class="nav-link" href="ferramentas.html">Ferramentas</a></li>
      </ul>
    </div>
  </div>
</nav>

<!-- CONTEÚDO -->
<div class="container mt-4">
  <h3 class="mb-4">📂 Análise do CNIS</h3>

  <div class="mb-3">
    <label class="form-label">Selecione o cliente:</label>
    <select class="form-select" id="clienteSelect">
      <option value="">Selecione...</option>
      <option value="paulo_cesar">Paulo Cesar Ribeiro</option>
    </select>
  </div>

  <div id="infoCliente" class="cliente-info d-none">
    <strong>👤 Nome:</strong> Paulo Cesar Ribeiro<br />
    <strong>📅 Nascimento:</strong> 20/12/1969<br />
    <strong>🧮 Idade:</strong> 53 anos, 9 meses e 4 dias<br />
    <strong>Sexo:</strong> Masculino
  </div>

  <div class="alert alert-success d-none" id="msgSucesso">✅ CNIS analisado com sucesso.</div>

  <div id="resultado" class="d-none">
    <h5>📊 Resultado da Análise</h5>
    <table class="table table-bordered mt-3">
      <thead class="table-light">
        <tr>
          <th>Empresa</th><th>Período</th><th>Remuneração</th><th>Status</th><th>Ação</th>
        </tr>
      </thead>
      <tbody id="tabelaResultado"></tbody>
    </table>

    <div id="resumoTempo" class="mt-2"></div>

    <div class="mt-4 painel-lateral">
      <h6>⏱️ Tempo por Empregador</h6>
      <ul class="list-group small" id="tempoEmpregador"></ul>
    </div>

    <button class="btn btn-success mt-4" onclick="gerarPDF()">📄 Gerar PDF</button>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
document.getElementById("clienteSelect").addEventListener("change", function () {
  const cliente = this.value;
  if (cliente === "paulo_cesar") {
    document.getElementById("infoCliente").classList.remove("d-none");

    // Simulando leitura do CNIS armazenado para esse cliente
    const cnisTexto = `
EMPRESA: Supermercado Brasil
PERIODO: 01/2010 a 12/2011
REMUNERACAO: 1500.00
EMPRESA: Indústria Sul
PERIODO: 01/2012 a 03/2013
REMUNERACAO: 7800.00
EMPRESA: Transportes X
PERIODO: 05/2014 a 06/2014
REMUNERACAO: 0.00`;

    processarCNIS(cnisTexto);
  }
});

function processarCNIS(conteudo) {
  const linhas = conteudo.trim().split("\n");
  let empresa = '', periodo = '', salario = 0;
  let totalValidos = 0, totalLacunas = 0;
  const tempoEmp = {}, tabela = document.getElementById("tabelaResultado");
  tabela.innerHTML = '';
  document.getElementById("tempoEmpregador").innerHTML = '';

  linhas.forEach(l => {
    if (l.startsWith("EMPRESA:")) empresa = l.split("EMPRESA:")[1].trim();
    if (l.startsWith("PERIODO:")) periodo = l.split("PERIODO:")[1].trim();
    if (l.startsWith("REMUNERACAO:")) {
      salario = parseFloat(l.split("REMUNERACAO:")[1].trim());
      const [inicio, fim] = periodo.split(' a ');
      const meses = calcularMeses(inicio, fim);
      let status = '', acao = '';
      if (salario === 0) {
        totalLacunas += meses;
        status = '<span class="badge badge-erro">Sem remuneração</span>';
        acao = 'Recolher';
      } else if (salario > 7500) {
        totalValidos += meses;
        status = '<span class="badge badge-aviso">Acima do teto</span>';
        acao = 'Reembolso';
      } else {
        totalValidos += meses;
        status = '<span class="badge badge-ok">OK</span>';
        acao = '—';
      }
      tempoEmp[empresa] = (tempoEmp[empresa] || 0) + meses;
      tabela.innerHTML += `<tr><td>${empresa}</td><td>${periodo}</td><td>R$ ${salario.toFixed(2)}</td><td>${status}</td><td>${acao}</td></tr>`;
    }
  });

  document.getElementById("resumoTempo").innerHTML = `
    <strong>🟢 Contribuições:</strong> ${converterMeses(totalValidos)}<br>
    <strong>🔴 Lacunas:</strong> ${converterMeses(totalLacunas)}`;
  Object.entries(tempoEmp).forEach(([emp, meses]) => {
    const li = document.createElement("li");
    li.className = "list-group-item d-flex justify-content-between";
    li.innerHTML = `<span>${emp}</span><span class="badge bg-primary">${converterMeses(meses)}</span>`;
    document.getElementById("tempoEmpregador").appendChild(li);
  });

  document.getElementById("msgSucesso").classList.remove("d-none");
  document.getElementById("resultado").classList.remove("d-none");
}

function calcularMeses(inicio, fim) {
  const [m1, a1] = inicio.split("/").map(Number);
  const [m2, a2] = fim.split("/").map(Number);
  return (a2 - a1) * 12 + (m2 - m1) + 1;
}

function converterMeses(m) {
  return `${Math.floor(m / 12)}a ${m % 12}m`;
}

function gerarPDF() {
  const resultado = document.getElementById("resultado");
  html2pdf().from(resultado).save("relatorio_cnis.pdf");
}
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
