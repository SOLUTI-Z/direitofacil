<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>DireitoF√°cil ‚Äì CNIS PDF</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    body { font-family: sans-serif; background: #f5f8fa; padding-top: 65px; }
    .navbar { background-color: #1a2d48; }
    .navbar-brand, .nav-link { color: white !important; }
    .card { background: #fff; border-radius: 10px; padding: 25px; box-shadow: 0 0 10px #ccc; }
    .cliente-info { background: #eef3f8; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
    .badge-ok { background-color: #198754; }
    .badge-aviso { background-color: #ffc107; color: #000; }
    .badge-erro { background-color: #dc3545; }
    .painel-lateral { background: #fff; border: 1px solid #ddd; padding: 15px; border-radius: 8px; }
  </style>
</head>
<body>
<nav class="navbar fixed-top navbar-expand-lg shadow">
  <div class="container-fluid">
    <a class="navbar-brand" href="painel.html">‚öñÔ∏è DireitoF√°cil</a>
  </div>
</nav>

<div class="container mt-4">
  <div class="card">
    <h3 class="mb-3">üìÇ An√°lise do CNIS (PDF)</h3>

    <div class="cliente-info">
      <strong>üë§ Nome:</strong> Paulo Cesar Ribeiro<br>
      <strong>üìÖ Nascimento:</strong> 20/12/1969<br>
      <strong>üßÆ Idade:</strong> 53 anos, 9 meses e 4 dias
    </div>

    <div class="mb-3">
      <label class="form-label">Deseja usar o CNIS j√° importado ou fazer upload manual?</label>
      <select class="form-select" id="opcaoFonte">
        <option value="">Selecione uma op√ß√£o</option>
        <option value="importado">Usar CNIS importado no cadastro</option>
        <option value="manual">Fazer upload manual</option>
      </select>
    </div>

    <div class="mb-3 d-none" id="uploadManual">
      <label class="form-label">Upload do CNIS (PDF do INSS):</label>
      <input type="file" class="form-control" id="pdfInput" accept="application/pdf" />
    </div>

    <button class="btn btn-primary" onclick="iniciarAnalise()">üîç Analisar CNIS</button>

    <div class="alert alert-success mt-3 d-none" id="msgSucesso">‚úÖ An√°lise conclu√≠da!</div>

    <div class="mt-4 d-none" id="resultado">
      <div id="relatorioCnis">
        <h5>üìä Resultado da An√°lise</h5>
        <table class="table table-bordered mt-3">
          <thead class="table-light">
            <tr>
              <th>Empresa</th><th>Per√≠odo</th><th>Remunera√ß√£o</th><th>Status</th><th>A√ß√£o</th>
            </tr>
          </thead>
          <tbody id="tabelaResultado"></tbody>
        </table>
        <div class="mt-2" id="resumoTempo"></div>
        <div class="mt-4 painel-lateral">
          <h6>‚è±Ô∏è Tempo por Empregador</h6>
          <ul class="list-group small" id="tempoEmpregador"></ul>
        </div>
      </div>
      <button class="btn btn-success mt-3" onclick="gerarPDF()">üìÑ Gerar PDF</button>
    </div>

    <div class="mt-4">
      <a href="painel.html" class="btn btn-outline-secondary">üîô Voltar ao menu</a>
    </div>
  </div>
</div>

<script>
document.getElementById("opcaoFonte").addEventListener("change", function () {
  document.getElementById("uploadManual").classList.toggle("d-none", this.value !== "manual");
});

function iniciarAnalise() {
  const opcao = document.getElementById("opcaoFonte").value;
  if (opcao === "importado") {
    // Simula√ß√£o: CNIS importado j√° salvo
    const conteudo = `
EMPRESA: Supermercado Brasil
PERIODO: 01/2010 a 12/2011
REMUNERACAO: 1500.00
EMPRESA: Ind√∫stria Sul
PERIODO: 01/2012 a 03/2013
REMUNERACAO: 7800.00
EMPRESA: Transportes X
PERIODO: 05/2014 a 06/2014
REMUNERACAO: 0.00`;
    processarCNIS(conteudo);
  } else if (opcao === "manual") {
    const file = document.getElementById("pdfInput").files[0];
    if (!file) return alert("Selecione um PDF.");
    const reader = new FileReader();
    reader.onload = function () {
      const typedarray = new Uint8Array(reader.result);
      pdfjsLib.getDocument(typedarray).promise.then(pdf => {
        pdf.getPage(1).then(page => {
          page.getTextContent().then(text => {
            const txt = text.items.map(item => item.str).join("\n");
            processarCNIS(txt);
          });
        });
      });
    };
    reader.readAsArrayBuffer(file);
  } else {
    alert("Escolha uma op√ß√£o para continuar.");
  }
}

function processarCNIS(conteudo) {
  const linhas = conteudo.split('\n');
  let empresa = '', periodo = '', salario = 0;
  let totalValidos = 0, totalLacunas = 0;
  const tempoEmp = {}, tabela = document.getElementById("tabelaResultado");
  tabela.innerHTML = '';
  document.getElementById("tempoEmpregador").innerHTML = '';

  linhas.forEach(l => {
    if (l.startsWith("EMPRESA:")) empresa = l.split("EMPRESA:")[1].trim();
    if (l.startsWith("PERIODO:")) periodo = l.split("PERIODO:")[1].trim();
    if (l.startsWith("REMUNERACAO:")) {
      salario = parseFloat(l.split("REMUNERACAO:")[1].trim());
      const [inicio, fim] = periodo.split(' a ');
      const meses = calcularMeses(inicio, fim);
      let status = '', acao = '';
      if (salario === 0) {
        totalLacunas += meses;
        status = '<span class="badge badge-erro">Sem remunera√ß√£o</span>';
        acao = 'Recolher';
      } else if (salario > 7500) {
        totalValidos += meses;
        status = '<span class="badge badge-aviso">Acima do teto</span>';
        acao = 'Reembolso';
      } else {
        totalValidos += meses;
        status = '<span class="badge badge-ok">OK</span>';
        acao = '‚Äî';
      }
      tempoEmp[empresa] = (tempoEmp[empresa] || 0) + meses;
      tabela.innerHTML += `<tr><td>${empresa}</td><td>${periodo}</td><td>R$ ${salario.toFixed(2)}</td><td>${status}</td><td>${acao}</td></tr>`;
    }
  });

  document.getElementById("resumoTempo").innerHTML = `
    <strong>üü¢ Contribui√ß√µes:</strong> ${converterMeses(totalValidos)}<br>
    <strong>üî¥ Lacunas:</strong> ${converterMeses(totalLacunas)}`;
  Object.entries(tempoEmp).forEach(([emp, meses]) => {
    const li = document.createElement("li");
    li.className = "list-group-item d-flex justify-content-between";
    li.innerHTML = `<span>${emp}</span><span class="badge bg-primary">${converterMeses(meses)}</span>`;
    document.getElementById("tempoEmpregador").appendChild(li);
  });

  document.getElementById("msgSucesso").classList.remove("d-none");
  document.getElementById("resultado").classList.remove("d-none");
}

function calcularMeses(inicio, fim) {
  const [m1, a1] = inicio.split("/").map(Number);
  const [m2, a2] = fim.split("/").map(Number);
  return (a2 - a1) * 12 + (m2 - m1) + 1;
}
function converterMeses(m) {
  return `${Math.floor(m / 12)}a ${m % 12}m`;
}
function gerarPDF() {
  const relatorio = document.getElementById("relatorioCnis");
  html2pdf().from(relatorio).set({
    margin: 0.5,
    filename: 'relatorio_cnis.pdf',
    jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
  }).save();
}
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
